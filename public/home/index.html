<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Inventory</title>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" href="home/style.css">
        <link href='https://fonts.googleapis.com/css?family=Roboto Slab' rel='stylesheet'>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    </head>
    <body>
        <div class="logout tooltip-container">
            <button type="button" class="btn btn-danger btn-lg" onclick="logout()" style="width: 50px; height: 50px; border-radius: 50%; padding: 0;">
                <img src="/images/logout.svg" alt="Logout" style="padding-left: 3px; padding-bottom: 3px; width: 25px; height: 30px; filter: invert(100%);">
            </button>
            <div class="tooltip">Logout</div>
        </div>
    <div class="signup-container">
        <h2 class="text-center" style="font-family: 'Roboto slab', sans-serif;  font-size: 50px">House Keeping Inventory</h2>
    
        <!-- <?php if (isset($_SESSION['message'])): ?>
            <div class="alert alert-success">
                <?php 
                    echo $_SESSION['message']; 
                    unset($_SESSION['message']);
                ?>
            </div>
        <?php endif; ?>
    
        <?php if (isset($_SESSION['error'])): ?>
            <div class="alert alert-danger">
                <?php 
                    echo $_SESSION['error']; 
                    unset($_SESSION['error']); 
                ?>
            </div>
        <?php endif; ?> -->

        <div id="error_div"></div>
    
        <div class="button-container">
            <button type="button" class="btn btn-success btn-lg" onclick="openAddProductModal()">Add Product</button>
    
            <div class="search-bar">
                <input id="search-input" type="search" class="form-control" placeholder="Search for a product"/>
                <button id="search-button" type="button" class="btn btn-primary">
                    <i class="fas fa-search"></i>
                </button>
            </div>
    
        </div>
    
        <div class="table-container">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th scope="col" class="active">Item Description</th>
                        <th scope="col" class="active">Serial No.</th>
                        <th scope="col" class="active">Quantity</th>
                        <th scope="col" class="active">Location</th>
                        <th scope="col" class="active">Actions</th>
                    </tr>
                </thead>

                <tbody id="rows"></tbody>
            </table>  
        </div>

        <div id="paginate_nav" class="pagination">
            <a id="prev" class="btn btn-primary" onclick="onPrev()">Previous</a>
    
            <div id="paginate_nums"></div>
        
            <a id="next" class="btn btn-primary" onclick="onNext()">Next</a>
        </div>
    </div>
    
    <!-- Delete Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <p>Are you sure you want to delete this product?</p>
            <form method="post" action="">
                <input type="hidden" id="deleteProductId" name="I_ID" value="">
                <button type="submit" name="delete" class="btn btn-danger">Yes</button>
                <button type="button" class="btn btn-light" onclick="closeModal()">No</button>
            </form>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddProductModal()">&times;</span>
            <h3>Add New Product</h3>

            <form id="addProductForm">

                <input type="hidden" name="add_product" value="1">

                <!-- Product Name Input -->
                <div class="form-group">
                    <label for="I_Product">Product Name</label>
                    <input type="text" id="I_Product" name="I_Product" class="form-control" required>
                </div>

                <div class="form-row d-flex" style="gap: 10px;">
                    <!-- Quantity Input -->
                    <div class="form-group" style="flex: 1;">
                        <label for="I_Quantity">Quantity</label>
                        <input type="number" id="I_Quantity" name="I_Quantity" class="form-control" required>
                    </div>

                    <!-- Unit Input -->
                    <div class="form-group" style="flex: 1;">
                        <label for="I_Unit">Unit</label>
                        <select id="I_Unit" name="I_Unit" class="form-control" required>
                            <option value="" disabled selected>Select Unit</option>
                            <option value="pieces">Pieces</option>
                            <option value="kg">Kg</option>
                            <option value="litre">Litre</option>
                            <option value="meter">Meter</option>
                            <option value="feet">Feet</option>
                            <option value="inches">Inches</option>
                        </select>
                    </div>
                </div>

                <!-- Serial Number Input -->
                <div class="form-group">
                    <label for="I_SN">Serial Number</label>
                    <input type="text" id="I_SN" name="I_SN" class="form-control">
                </div>

                

                <!-- Location Input -->
                <div class="form-group">
                    <label for="I_Location">Location</label>
                    <input type="text" id="I_Location" name="I_Location" class="form-control" required>
                </div>


                <div class="form-group"> <!-- added by zed-->
                    <label for="E_Storage">Storage:</label>
                    <select id="E_Storage" name="E_Storage" class="form-control" required>
                        <option value="" disabled selected>Select Storage</option>
                        <option value="Housekeeping">Housekeeping</option>
                        <option value="Construction">Construction</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-success">Add Product</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h3>Edit Product</h3>
            <form method="post" action="">
                <input type="hidden" id="editProductId" name="I_ID" value="">

                <div class="form-group">
                    <label for="editProductName">Product Name:</label>
                    <input type="text" class="form-control" id="editProductName" name="I_Product" value="" readonly>
                </div>

                <div class="form-group">
                    <label for="editQuantity">Quantity:</label>
                    <input type="number" class="form-control" id="editQuantity" name="I_Quantity" value="" required>
                </div>

                <div class="form-group">
                    <label for="editUnit">Unit:</label>
                    <select class="form-control" id="editUnit" name="I_Unit" required>
                        <option value="" disabled>Select Unit</option>
                        <option value="pieces">Pieces</option>
                        <option value="kg">Kg</option>
                        <option value="litre">Litre</option>
                        <option value="meter">Meter</option>
                        <option value="feet">Feet</option>
                        <option value="inches">Inches</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editLocation">Located at:</label>
                    <input type="text" class="form-control" id="editLocation" name="I_Location" value="" required>
                </div>

                <button type="submit" name="edit" class="btn btn-success">Save Changes</button> <!-- TODO: Add functionality -->
            </form>
        </div>
    </div>

<script>
    function openModal(productId) {
        document.getElementById('deleteModal').style.display = 'block';
        document.getElementById('deleteProductId').value = productId;
    }

    function closeModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    function openEditModal(productId, productName, productQuantity, productLocation, productQuantityUnit) {
        document.getElementById('editModal').style.display = 'block';
        document.getElementById('editProductId').value = productId;
        document.getElementById('editProductName').value = productName;
        document.getElementById('editQuantity').value = productQuantity;
        document.getElementById('editLocation').value = productLocation;
        
        // Set the unit dropdown
        const unitDropdown = document.getElementById('editUnit');
        for (let option of unitDropdown.options) {
            if (option.value === productQuantityUnit) {
                option.selected = true;
                break;
            }
        }
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    // For communicating with backend for adding equipment (added by zed)
    document.getElementById('addProductModal').addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent the default form submission

        const unitMapping = { // Since UNIT_ID is int in the DB we map it to its corresponding int
            "pieces": 1,
            "kg": 2,
            "litre": 3,
            "meter": 4,
            "feet": 5,
            "inches": 6
        };

        const selectedUnit = document.getElementById('I_Unit').value;
        const unitId = unitMapping[selectedUnit];

        const productData = {
            I_Product: document.getElementById('I_Product').value,
            I_SN: document.getElementById('I_SN').value,
            I_Quantity: parseInt(document.getElementById('I_Quantity').value, 10),
            UNIT_ID: unitId,
            I_Location: document.getElementById('I_Location').value,
            E_Storage: document.getElementById('E_Storage').value
        };

        fetch('/api/equipment/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem("Lantaka-IMS-Sess-Token")}`
            },
            body: JSON.stringify(productData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    alert("Product added successfully");
                    closeAddProductModal();
                    location.reload();
                } else {
                    alert("Error adding product: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred while adding the product.");
            });
    });


    // open the modal
    function openAddProductModal() {
        document.getElementById('addProductModal').style.display = 'block';
    }


    // close the modal
    function closeAddProductModal() {
        document.getElementById('addProductModal').style.display = 'none';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('addProductModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }

    function alertCard(message){
        return `
            <div class="alert alert-danger">
                ${message}
            </div>
        `
    }


    document.addEventListener("DOMContentLoaded", (event) => {
        const table = document.getElementById("rows");
        const error_div = document.getElementById("error_div");

        fetch('/api/equipment/view', {
            method: 'GET'
        })
        .then(response => {
            if (!response.ok){
                error_div.innerHTML = alertCard("Something went wrong in fetching the equipment. Contact the developers to troubleshoot...");
            }
            return response.json();
        })
        .then(data =>{
            if (data.status == "success"){
                for (let equipment of data.equipment) {
                    appendEquipment(equipment);
                }
                updateEquipmentVars();
                paginate(getEquipmentArray());
            } else {
                throw "The response given the server indicated an unsuccessful retrieval. Contact the developers to troubleshoot..."
            }
        })
        .catch(error => {
            error_div.innerHTML = alertCard("Error: " + error);
        });
    });


    function logout(){
        localStorage.removeItem("Lantaka-IMS-Sess-Token");
        // alert("removed");
        document.location.href = '/';
    }


    const token = localStorage.getItem("Lantaka-IMS-Sess-Token");
    if (!token){
        window.location.href = "/?status=Please Log In First";
    } else {
        fetch('/api/validate-token', {
            method: "GET",
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok){
                localStorage.removeItem("Lantaka-IMS-Sess-Token");
                window.location.href = "/?status=Session Expired. Login Again.";
            }
            return response.json();
        })
        .then(data => {
            console.log(data);
            document.body.classList.remove("d-none");
        })
        .catch(error => {
            console.error("Error:", error);
            window.location.href = "/?status=INTERNAL_SERVER_ERROR";  // Redirect in case of an error
        });
    }

</script>

<script src="/home/search_and_paginate.js"></script>

</body>
</html>